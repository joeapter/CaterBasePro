{% load form_extras %}
{% if form.menu_items %}
    <h3>üçΩ Menu Builder</h3>
    <p class="help">
        Use the meal list above to add additional courses (e.g. Friday Dinner, Shabbos Lunch). Each item can be toggled on a per-meal basis below.
    </p>
    <div class="meal-column-heads">
        {% for meal in form.meal_names %}
            <span>{{ meal }}</span>
        {% endfor %}
    </div>
    {% regroup form.menu_items by category as category_list %}
    <div class="menu-matrix-card">
        <table class="menu-matrix">
            <thead>
                <tr>
                    <th style="min-width: 260px;">Menu item</th>
                    {% for meal in form.meal_names %}
                        <th>{{ meal }}</th>
                    {% endfor %}
                </tr>
            </thead>
            {% for group in category_list %}
                <tbody>
                    <tr class="category-row">
                        <td colspan="{{ form.meal_names|length|add:1 }}">
                            {{ group.grouper.name|default:"Chef's Selection" }}
                        </td>
                    </tr>
                    {% for item in group.list %}
                        <tr>
                            <td>
                                <strong>{{ item.name }}</strong>
                                {% if item.description %}
                                    <br><small>{{ item.description }}</small>
                                {% endif %}
                            </td>
                            {% for meal in form.meal_names %}
                                {% with meal_index=forloop.counter0 %}
                                    {% meal_field form "include_item" item.id meal_index as include_field %}
                                    {% meal_field form "servings_item" item.id meal_index as servings_field %}
                                    <td class="meal-cell"
                                        data-meal="{{ meal }}"
                                        data-price="{{ item.cost_per_serving|mul:item.markup|floatformat:'4' }}"
                                        data-servings-field-id="{{ servings_field.id_for_label }}">
                                        {{ include_field }}
                                        {{ servings_field }}
                                    </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="{{ form.meal_names|length|add:1 }}">
                            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end;">
                                <div style="min-width:180px;flex:1;">
                                    <label style="font-weight:700;">Add new item</label>
                                    <input type="text" name="new_item_name_{{ group.grouper.id|default:'none' }}" placeholder="Name" style="width:100%;">
                                </div>
                                <div style="min-width:160px;flex:1;">
                                    <label style="font-weight:700;">Description</label>
                                    <input type="text" name="new_item_description_{{ group.grouper.id|default:'none' }}" placeholder="Description" style="width:100%;">
                                </div>
                                <div style="width:120px;">
                                    <label style="font-weight:700;">Cost/serving</label>
                                    <input type="number" step="0.01" min="0" name="new_item_cost_{{ group.grouper.id|default:'none' }}" placeholder="0.00" style="width:100%;">
                                </div>
                                <div style="width:120px;">
                                    <label style="font-weight:700;">Markup</label>
                                    <input type="number" step="0.01" min="0" name="new_item_markup_{{ group.grouper.id|default:'none' }}" placeholder="3.00" style="width:100%;">
                                </div>
                                <div style="width:140px;">
                                    <label style="font-weight:700;">Servings/person</label>
                                    <input type="number" step="0.01" min="0.01" name="new_item_servings_{{ group.grouper.id|default:'none' }}" placeholder="1.00" style="width:100%;">
                                </div>
                            </div>
                            <p class="help" style="margin:6px 0 0;">Save the estimate to add this item; it will appear above with a checkbox.</p>
                        </td>
                    </tr>
                </tbody>
            {% endfor %}
        </table>
    </div>
    <div class="meal-summary-bar">
        {% for meal in form.meal_names %}
            <div class="meal-summary-pill" data-meal="{{ meal }}">
                <div class="meal-summary-text">
                    <span>{{ meal }}</span>
                    <span class="meal-summary-value" data-meal="{{ meal }}">0.00 / guest ‚Ä¢ 0.00</span>
                </div>
                <div class="meal-summary-override">
                    <input type="number" step="0.01" placeholder="Override per guest" class="meal-override-input" data-meal="{{ meal }}">
                    <button type="button" class="button meal-override-btn" data-meal="{{ meal }}">Apply</button>
                </div>
                <div class="meal-guest-override">
                    <label>Adults</label>
                    <input type="number" min="0" step="1" class="meal-guest-input" data-meal="{{ meal }}" data-type="adults" placeholder="Adults">
                    <label>Kids</label>
                    <input type="number" min="0" step="1" class="meal-guest-input" data-meal="{{ meal }}" data-type="kids" placeholder="Kids">
                    <button type="button" class="button meal-guest-apply" data-meal="{{ meal }}">Set guests</button>
                    <span class="meal-guest-display" data-meal="{{ meal }}"></span>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p class="help">No menu items are active for this caterer yet.</p>
{% endif %}
<div style="display:none;">
    {{ form.manual_meal_totals_json }}
    {{ form.meal_guest_overrides_json }}
</div>
