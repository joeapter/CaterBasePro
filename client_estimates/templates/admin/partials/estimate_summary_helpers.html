{% load i18n form_extras %}
{% if original %}
    {% url 'admin:client_estimates_estimate_print' original.pk as preview_url %}
{% endif %}
<div class="estimate-summary-cards">
    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #d1d5db;">Line item</th>
                <th style="text-align:right; padding:8px; border-bottom:1px solid #d1d5db;">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% with sections=form.instance.meal_sections %}
            <tr>
                <td style="padding:8px;">Total catering cost</td>
                <td style="padding:8px; text-align:right;">
                    {% if sections %}
                        {{ form.instance.meal_grand_total }}
                    {% else %}
                        {{ form.instance.food_price_per_person }}
                    {% endif %}
                </td>
            </tr>
            {% endwith %}
            <tr>
                <td style="padding:8px;">Extras & decor</td>
                <td style="padding:8px; text-align:right;">{{ form.instance.extras_total }}</td>
            </tr>
            <tr>
                <td style="padding:8px;">Staff total</td>
                <td style="padding:8px; text-align:right;">
                    {% if form.instance.is_ala_carte %}—{% else %}{{ form.instance.staff_total }}{% endif %}
                </td>
            </tr>
            <tr>
                <td style="padding:8px;">Delivery &amp; dishes</td>
                <td style="padding:8px; text-align:right;">
                    {% if form.instance.is_ala_carte %}—{% else %}{{ form.instance.dishes_total }}{% endif %}
                </td>
            </tr>
            <tr style="font-weight:600;">
                <td style="padding:8px;">Grand total</td>
                <td style="padding:8px; text-align:right;">{{ form.instance.grand_total }}</td>
            </tr>
            <tr>
                <td style="padding:8px;">Deposit ({{ form.instance.deposit_percentage }}%)</td>
                <td style="padding:8px; text-align:right;">{{ form.instance.deposit_amount }}</td>
            </tr>
            <tr>
                <td style="padding:8px;">Balance due</td>
                <td style="padding:8px; text-align:right;">{{ form.instance.balance_due }}</td>
            </tr>
        </tbody>
    </table>
</div>

{% with sections=form.instance.meal_sections %}
    {% if sections %}
        <div class="estimate-summary-card" style="background:#fff; border:1px solid #e4e4e7; color:#0f172a;">
            <h4>Per-Meal Reference</h4>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:6px;">Meal</th>
                        <th style="text-align:right; padding:6px;">Per guest</th>
                        <th style="text-align:right; padding:6px;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for section in sections %}
                        <tr>
                            <td style="padding:6px;">{{ section.name }}</td>
                            <td style="padding:6px; text-align:right;">{{ section.price_per_guest }}</td>
                            <td style="padding:6px; text-align:right;">{{ section.total }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
{% endwith %}

{% with service_rows=form.instance.per_meal_service_summary %}
    {% if service_rows %}
        <div class="estimate-summary-card" style="background:#fff; border:1px solid #e4e4e7; color:#0f172a;">
            <h4>Per-Meal Logistics</h4>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:6px;">Meal</th>
                        <th style="text-align:center; padding:6px;">Real dishes</th>
                        <th style="text-align:right; padding:6px;">Dishes / guest</th>
                        <th style="text-align:right; padding:6px;">Staff hrs</th>
                        <th style="text-align:right; padding:6px;">Tip / waiter</th>
                        <th style="text-align:right; padding:6px;">Staff total</th>
                        <th style="text-align:right; padding:6px;">Dishes total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in service_rows %}
                        <tr>
                            <td style="padding:6px;">{{ row.meal }}</td>
                            <td style="padding:6px; text-align:center;">{{ row.wants_real_dishes|yesno:"Yes,No" }}</td>
                            <td style="padding:6px; text-align:right;">{{ row.real_dishes_price_per_person }} {{ form.instance.currency }}</td>
                            <td style="padding:6px; text-align:right;">{{ row.staff_hours }}</td>
                            <td style="padding:6px; text-align:right;">{{ row.staff_tip_per_waiter }} {{ form.instance.currency }}</td>
                            <td style="padding:6px; text-align:right;">{{ row.staff_pay_total|add:row.staff_tip_total }} {{ form.instance.currency }}</td>
                            <td style="padding:6px; text-align:right;">{{ row.dishes_total }} {{ form.instance.currency }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% with fx=form.instance.exchange_rate|default_if_none:"1" %}
                <p class="help" style="margin:8px 0 0;">Delivery fee (once): {{ form.instance.real_dishes_flat_fee|default:form.instance.caterer.real_dishes_flat_fee|mul:fx|floatformat:"2" }} {{ form.instance.currency }}</p>
            {% endwith %}
        </div>
    {% endif %}
{% endwith %}

<div class="estimate-summary-card" style="background:#fff; border:1px solid #e4e4e7; color:#0f172a;">
    <h4>Payment terms</h4>
    <p>{{ form.instance.payment_terms|default:"Define payment terms above to show them here." }}</p>
    {% if form.instance.payment_method %}
        <p><strong>Method:</strong> {{ form.instance.get_payment_method_display }}</p>
    {% endif %}
</div>

{% if original %}
    <div class="estimate-summary-actions">
        <button type="button" class="button" data-print-preview="{{ preview_url }}">Generate PDF Estimate</button>
        <button type="button" class="button" data-print-preview="{{ preview_url }}?print=1" data-auto-print="true">Download / Print</button>
        <button type="button"
                class="button"
                data-whatsapp
                data-preview="{{ preview_url }}"
                data-customer="{{ original.customer_name }}"
                data-event="{{ original.event_type }}"
                data-total="{{ original.grand_total }}"
                data-currency="{{ original.currency }}"
                data-invoice="{{ original.is_invoice|yesno:'true,false' }}">
            Send via WhatsApp Web
        </button>
        <button type="submit" class="button button-secondary" name="_convert_to_invoice">
            {% if original.is_invoice %}
                Update Invoice
            {% else %}
                Convert to Invoice
            {% endif %}
        </button>
    </div>
{% else %}
    <p class="help">Save the estimate to unlock PDF, WhatsApp, and invoice actions.</p>
{% endif %}

<div class="signature-preview">
    <div class="signature-line"></div>
    <small>Client signature &amp; acceptance of terms</small>
</div>
